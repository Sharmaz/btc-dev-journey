"use strict";(globalThis.webpackChunkbtc_dev_journey=globalThis.webpackChunkbtc_dev_journey||[]).push([[402],{2793(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"tracks/protocol-developer/bitcoin-core-internals/consensus","title":"Consensus Rules","description":"Understanding Bitcoin\'s consensus rules, validation logic, and soft fork activation","source":"@site/docs/tracks/protocol-developer/01-bitcoin-core-internals/consensus.md","sourceDirName":"tracks/protocol-developer/01-bitcoin-core-internals","slug":"/tracks/protocol-developer/bitcoin-core-internals/consensus","permalink":"/docs/tracks/protocol-developer/bitcoin-core-internals/consensus","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3,"title":"Consensus Rules","description":"Understanding Bitcoin\'s consensus rules, validation logic, and soft fork activation"},"sidebar":"guideSidebar","previous":{"title":"Code Architecture","permalink":"/docs/tracks/protocol-developer/bitcoin-core-internals/code-architecture"},"next":{"title":"Languages & Tools","permalink":"/docs/tracks/protocol-developer/languages-tools/"}}');var t=s(4848),o=s(8453);const r={sidebar_position:3,title:"Consensus Rules",description:"Understanding Bitcoin's consensus rules, validation logic, and soft fork activation"},l="Consensus Rules",c={},d=[{value:"What Are Consensus Rules?",id:"what-are-consensus-rules",level:2},{value:"Block-Level Rules",id:"block-level-rules",level:3},{value:"Transaction-Level Rules",id:"transaction-level-rules",level:3},{value:"Script Validation",id:"script-validation",level:3},{value:"Soft Forks",id:"soft-forks",level:2},{value:"Notable Soft Forks",id:"notable-soft-forks",level:3},{value:"Activation Mechanisms",id:"activation-mechanisms",level:3},{value:"Validation in Code",id:"validation-in-code",level:2},{value:"Why Consensus Bugs Are Critical",id:"why-consensus-bugs-are-critical",level:2},{value:"Recommended Reading",id:"recommended-reading",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"consensus-rules",children:"Consensus Rules"})}),"\n",(0,t.jsx)(n.p,{children:"Consensus rules are the most critical part of Bitcoin. They define what makes a block and transaction valid. Every full node on the network independently enforces these rules \u2014 if a block violates any rule, it is rejected regardless of how much proof-of-work backs it."}),"\n",(0,t.jsx)(n.h2,{id:"what-are-consensus-rules",children:"What Are Consensus Rules?"}),"\n",(0,t.jsx)(n.p,{children:"Consensus rules are the set of conditions that every block and transaction must satisfy to be considered valid. They include:"}),"\n",(0,t.jsx)(n.h3,{id:"block-level-rules",children:"Block-Level Rules"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Block size must not exceed the weight limit (4M weight units)"}),"\n",(0,t.jsx)(n.li,{children:"Block header hash must be below the current difficulty target"}),"\n",(0,t.jsx)(n.li,{children:"Timestamp must be greater than the median of the last 11 blocks"}),"\n",(0,t.jsx)(n.li,{children:"First transaction must be a coinbase (and only the first)"}),"\n",(0,t.jsx)(n.li,{children:"Coinbase reward must not exceed the block subsidy + fees"}),"\n",(0,t.jsx)(n.li,{children:"Merkle root must match the transactions in the block"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"transaction-level-rules",children:"Transaction-Level Rules"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Inputs must reference existing, unspent outputs (UTXOs)"}),"\n",(0,t.jsx)(n.li,{children:"Input scripts must satisfy the corresponding output scripts"}),"\n",(0,t.jsx)(n.li,{children:"Total input value must be >= total output value (difference is the fee)"}),"\n",(0,t.jsx)(n.li,{children:"No double-spending within the same block"}),"\n",(0,t.jsx)(n.li,{children:"Transaction must not be a duplicate of an existing unconfirmed transaction"}),"\n",(0,t.jsx)(n.li,{children:"Signature operations must not exceed limits"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"script-validation",children:"Script Validation"}),"\n",(0,t.jsx)(n.p,{children:"Script validation is where spending conditions are checked:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"For each input:\n  1. Retrieve the UTXO being spent\n  2. Execute the unlocking script (scriptSig / witness)\n  3. Execute the locking script (scriptPubKey)\n  4. If execution succeeds \u2192 input is valid\n  5. If execution fails \u2192 entire transaction is invalid\n"})}),"\n",(0,t.jsx)(n.h2,{id:"soft-forks",children:"Soft Forks"}),"\n",(0,t.jsx)(n.p,{children:"Soft forks tighten the consensus rules \u2014 blocks that were previously valid become invalid. Old nodes still accept the new blocks (they don't violate any old rules), so the network doesn't split."}),"\n",(0,t.jsx)(n.h3,{id:"notable-soft-forks",children:"Notable Soft Forks"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Soft Fork"}),(0,t.jsx)(n.th,{children:"Year"}),(0,t.jsx)(n.th,{children:"BIP(s)"}),(0,t.jsx)(n.th,{children:"What Changed"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"P2SH"}),(0,t.jsx)(n.td,{children:"2012"}),(0,t.jsx)(n.td,{children:"BIP-16"}),(0,t.jsx)(n.td,{children:"Pay-to-Script-Hash support"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"CLTV"}),(0,t.jsx)(n.td,{children:"2015"}),(0,t.jsx)(n.td,{children:"BIP-65"}),(0,t.jsx)(n.td,{children:"Absolute timelocks"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"CSV"}),(0,t.jsx)(n.td,{children:"2016"}),(0,t.jsx)(n.td,{children:"BIP-68, 112, 113"}),(0,t.jsx)(n.td,{children:"Relative timelocks"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"SegWit"}),(0,t.jsx)(n.td,{children:"2017"}),(0,t.jsx)(n.td,{children:"BIP-141, 143, 144"}),(0,t.jsx)(n.td,{children:"Witness data separation, malleability fix"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Taproot"}),(0,t.jsx)(n.td,{children:"2021"}),(0,t.jsx)(n.td,{children:"BIP-340, 341, 342"}),(0,t.jsx)(n.td,{children:"Schnorr signatures, MAST"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"activation-mechanisms",children:"Activation Mechanisms"}),"\n",(0,t.jsx)(n.p,{children:"How soft forks get activated on the network:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"BIP-9 (Version Bits)"})," \u2014 Miners signal readiness; activates after threshold"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"BIP-8 (Mandatory Activation)"})," \u2014 Similar to BIP-9 but with forced activation option"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Speedy Trial"})," \u2014 Used for Taproot; short signaling window, delayed activation"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"UASF (User Activated Soft Fork)"})," \u2014 Nodes enforce rules regardless of miner signaling"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"validation-in-code",children:"Validation in Code"}),"\n",(0,t.jsx)(n.p,{children:"The key validation functions in Bitcoin Core:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"CheckBlock()          \u2192 Basic block structure checks\nContextualCheckBlock() \u2192 Checks that depend on chain state\nConnectBlock()        \u2192 Full validation + UTXO set update\nCheckTransaction()    \u2192 Individual transaction validation\n"})}),"\n",(0,t.jsxs)(n.p,{children:["The validation code lives primarily in ",(0,t.jsx)(n.code,{children:"src/validation.cpp"}),", with consensus-specific checks in ",(0,t.jsx)(n.code,{children:"src/consensus/"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"why-consensus-bugs-are-critical",children:"Why Consensus Bugs Are Critical"}),"\n",(0,t.jsx)(n.p,{children:"A consensus bug can cause:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Chain split"})," \u2014 Nodes disagree on which chain is valid"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Inflation"})," \u2014 More coins created than the 21M limit"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Theft"})," \u2014 Funds spent without valid signatures"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Network halt"})," \u2014 Nodes reject all new blocks"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"This is why consensus code changes require the most rigorous review process in all of open source software."}),"\n",(0,t.jsx)(n.h2,{id:"recommended-reading",children:"Recommended Reading"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://en.bitcoin.it/wiki/Protocol_rules",children:"Bitcoin's consensus rules (Bitcoin Wiki)"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/bitcoin/bips/blob/master/bip-0009.mediawiki",children:"BIP-9: Version Bits"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://chaincode.com/",children:"Chaincode Labs: Bitcoin Protocol Development Curriculum"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},8453(e,n,s){s.d(n,{R:()=>r,x:()=>l});var i=s(6540);const t={},o=i.createContext(t);function r(e){const n=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);